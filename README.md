# Aurora Cross-Account Snapshot Restore & Column Encryption (CloudFormation + Lambda)

This project automates the process of restoring an encrypted Aurora MySQL snapshot from another AWS account (without sharing the original KMS key) and running a stored procedure to encrypt specific columns.

## Features

- Cross-account encrypted Aurora snapshot restore
- Uses a **different KMS key** (owned by target account)
- Aurora DB cluster + instance provisioning via CloudFormation
- Post-restore column-level encryption using AWS Lambda and MySQL stored procedure

---

## Project Structure

```
aurora-crossaccount-restore-encrypt/
├── template.yaml                 # CloudFormation Template
├── lambda/
│   ├── index.py                  # Lambda function to execute encryption
│   └── encrypt_column_proc.sql   # SQL to define the encryption procedure
```

---

## Prerequisites

- S3 bucket to upload zipped Lambda package
- AWS CLI configured with access to Account B
- Subnet and security group IDs for Aurora cluster
- A KMS key in Account B to re-encrypt the snapshot

---

## Deployment Instructions

### 1. Zip and Upload Lambda Code

```bash
cd lambda
zip -r ../encrypt.zip .
aws s3 cp ../encrypt.zip s3://your-bucket-name/lambda/encrypt.zip
```

### 2. Update `template.yaml`

Replace:
- `PLACEHOLDER_BUCKET` with your actual S3 bucket name

### 3. Deploy CloudFormation

```bash
aws cloudformation deploy   --template-file template.yaml   --stack-name aurora-restore-encrypt   --capabilities CAPABILITY_NAMED_IAM   --parameter-overrides \
    SnapshotIdentifier=arn:aws:rds:region:accountA:snapshot:snap-name \
    DBClusterIdentifier=my-restored-cluster \
    DBInstanceIdentifier=my-instance \
    KmsKeyId=arn:aws:kms:region:accountB:key/key-id \
    DBName=mydb \
    MasterUsername=admin \
    MasterUserPassword=MySecurePass123 \
    DBInstanceClass=db.r6g.large \
    SubnetIds='["subnet-abc","subnet-def"]' \
    SecurityGroupIds='["sg-xyz"]' \
    LambdaEncryptionKey=mysecretkey
```

---

## Output

- Aurora cluster and instance deployed
- Lambda can be triggered to encrypt specified columns (email, password in this example)
- Modify the Lambda environment variables for custom table/columns

---

## Security Notes

- This setup avoids sharing the original KMS key by re-encrypting the snapshot
- Credentials are passed via environment variables — for production, use Secrets Manager
- Add IAM permissions to limit scope in Lambda

---

## License

MIT License

---

## Author

Generated by OpenAI GPT with custom deployment logic
